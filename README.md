# eBay OAuth2 Client Flow Fix for Spring Boot
Spring Boot's automatically configured OAuth2 Client Flow doesn't work with eBay because eBay's OAuth2 is somewhat different from others (for some reason, after user's consent, it redirects not to **redirect_uri** parameter but to separate success/failure URL, details below). This fix applies new filter that should work with eBay correctly.

Works only in non-reactive web apps. Also bear in mind that it isn't LOGIN, it is only a CLIENT that automatically retrieves OAuth2 token and saves it in repository for current user (in memory by default, can be retrieved by autowired OAuth2AuthorizedClientService). 
After getting and saving token app redirects to success URL, so your own controllers should do next actions after redirection to that URL.

## Why Spring Boot's default autoconfiguration can't use eBay's current OAuth2 API
eBay uses authorization code grant type. According to OAuth2 specifications, your app should send request with some info and **redirect_uri** parameter. Then authorization server should redirect to your app's endpoint with authorization code in attributes using that **redirect_uri**.
However, eBay's API registers **redirect_uri** only as some kind of identifier for your app's requests but actually redirects to another URL that is separately specified in eBay's developer settings by developer. Spring Boot's filters only accept
authorziation code redirections with the same exact URL that was provided in request in *redirect_uri* parameter. This fix allows to specify different **redirect_uri** parameter for request and actual authorization code redirect URI eBay redirects to.

Next, authorization code should be used to retrieve the final OAuth2 token. Again, according to OAuth2 specifications, authorization server should respond with JSON-object that contains not only token itself but also additional info like expiration date and token type. Token type should be 'Bearer'. However, eBay responds with 'User Access Token' type. Spring Boot's default converters do not accept types other than 'Bearer'. At some point, that leads to exception and token's 'rejection'.

This fix applies new filter that uses new converter. Everything is configured to work with eBay's differences correctly.

## Installation and configuration
### Initial setup
Add release (.jar file) as a library to your project. (Working on adding to Maven)

As stated above, eBay uses different **redirect_uri** parameter and actual success/failure URL that eBay redirects to. Use application.properties as always to configure eBay's OAuth2 settings ([Authorization Grant Support](https://docs.spring.io/spring-security/reference/servlet/oauth2/client/authorization-grants.html)) (use 'ebay' as registrationId):
```
spring.security.oauth2.client.registration.ebay.client-id=your_client_id
spring.security.oauth2.client.registration.ebay.client-secret=your_client_secret
spring.security.oauth2.client.registration.ebay.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.ebay.redirect-uri=redirect_uri_generated_by_ebay
spring.security.oauth2.client.registration.ebay.scope=scope
spring.security.oauth2.client.registration.ebay.client-authentication-method=client_secret_basic
spring.security.oauth2.client.provider.ebay.authorization-uri=https://auth.ebay.com/oauth2/authorize
spring.security.oauth2.client.provider.ebay.token-uri=https://api.ebay.com/identity/v1/oauth2/token
spring.security.oauth2.client.registration.ebay.authorization-code-redirect-uri={baseUrl}/login/oauth2/code/{registrationId}
```
**redirect_uri** parameter: you should insert redirect_uri that was auto-generated by eBay's API in your developer page. 

To specify actual success/failure URL eBay redirects to after user's consent with authorization code, use new property **authorization-code-redirect-uri** (don't pay attention if your IDE marks it in red color). Like in **redirect_uri** you are able to use dynamic arguments like {baseUrl}, {registrationId}, etc. Not only it will be used to find authorization code after eBay's redirection to this URL after user's consent, it will also be used as a success URL after the entire flow (retrieving and saving final OAuth2 token) AND a failure URL with errors if something would go wrong.

### Autoconfiguration
Then, you should configure your SecurityFilterChain to work as OAuth2 Client (method *oauth2Client()* in HttpSecurity), something like this:
```
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity httpSecurity) throws Exception {
        return httpSecurity
                .oauth2Client(Customizer.withDefaults())
                .build();
    }

}
```
Then, configuration for eBay specifically should be done automatically if your app is non-reactive and 'authorization-code-redirect-uri' is specified.

### Manual configuration
If you want to manually configure eBay's filter (for example, you want your own registrationId), then you can use OAuth2eBayAuthorizationCodeGrantFilterBuilder to build filter and add it to SecurityFilterChain. Example:
```
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity httpSecurity,
                                                   ClientRegistrationRepository clientRegistrationRepository,
                                                   OAuth2AuthorizedClientRepository authorizedClientRepository) throws Exception {

        return httpSecurity
                .oauth2Client(Customizer.withDefaults())
                .addFilter(OAuth2eBayAuthorizationCodeGrantFilterBuilder
                        .withRepositories(clientRegistrationRepository, authorizedClientRepository)
                        .eBayClientRegistrationId("ebay_us")
                        .authorizationCodeRedirectUri("{baseUrl}/ebay_us")
                        .build())
                .build();
    }

}
```
*OAuth2eBayAuthorizationCodeGrantFilterBuilder.withRepositories(clientRegistrationRepository, authorizedClientRepository)* is used for initial builder creation with specified ClientRegistrationRepository and OAuth2AuthorizedClientRepository (they should be created automatically after Spring Boot's OAuth2 configuration). 

*eBayClientRegistrationId("registrationId")* is used to configure your own registration ID for eBay's properties. *authorizationCodeRedirectUri("success/failure_url_with_authorization_code")* is used to configure **authorization-code-redirect-uri** property.

## Additional info
Classes in this library can be used to create filters for another APIs that use different token types or success URLs. Read docs in classes for details.
